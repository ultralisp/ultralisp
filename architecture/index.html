<html lang=en>
 <head>
  <meta charset=UTF-8><meta name=viewport
      content="width=device-width, initial-scale=1">
  <title>Architecture</title>
  <link rel=alternate
        href="https://ultralisp.github.io/ultralisp/changelog.xml"
        type="application/rss+xml">
  <link rel=stylesheet type="text/css"
        href="../theme.css">
  <script type="text/javascript" src="../jquery.js"></script>
  <script type="text/javascript" src="../toc.js"></script>
  <script type="text/javascript">$(document).ready(function() {$('a:has(img)').css('border-bottom', 'none')})</script>
  <link rel=stylesheet type="text/css"
      href="../highlight.min.css">
  <script type="text/javascript"
          src="../highlight.min.js"></script>
  <script type="text/javascript">hljs.highlightAll();</script>
 </head>
 <body>
  <div class=page><div class=sidebar><div class=header><form class=search method=GET
      action="../search/">
      <input type=text name=q>
      <input type=submit value=Search><span id=search-progress></span>
     </form>
    </div><div class=content><div class=page-toc><ul><li><p><a href="../#x-28ULTRALISP-DOCS-2FINDEX-3A-40INDEX-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29" data-document="../" data-node="x-28ULTRALISP-DOCS-2FINDEX-3A-40INDEX-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29">Introduction</a></p><ul><li><p><a href="../#what-is-this" data-document="../" data-node="what-is-this">What is this?</a></p></li><li><p><a href="../#how-to-use-it" data-document="../" data-node="how-to-use-it">How to use it?</a></p></li></ul></li><li><p><a href="#x-28ULTRALISP-DOCS-2FARCHITECTURE-3A-3A-40ARCHITECTURE-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29" data-document="" data-node="x-28ULTRALISP-DOCS-2FARCHITECTURE-3A-3A-40ARCHITECTURE-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29">Architecture</a></p><ul><li><p><a href="#components-of-the-system" data-document="" data-node="components-of-the-system">Components of the system</a></p><ul><li><p><a href="#main-app" data-document="" data-node="main-app">MainApp</a></p></li><li><p><a href="#worker" data-document="" data-node="worker">Worker</a></p></li><li><p><a href="#gearman" data-document="" data-node="gearman">Gearman</a></p></li><li><p><a href="#file-storage" data-document="" data-node="file-storage">FileStorage</a></p></li></ul></li></ul></li><li><p><a href="../dev/#x-28ULTRALISP-DOCS-2FDEV-3A-3A-40DEV-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29" data-document="../dev/" data-node="x-28ULTRALISP-DOCS-2FDEV-3A-3A-40DEV-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29">Development</a></p><ul><li><p><a href="../dev/#running-in-dev" data-document="../dev/" data-node="running-in-dev">Running in dev</a></p><ul><li><p><a href="../dev/#easy-way" data-document="../dev/" data-node="easy-way">Easy way</a></p></li></ul></li><li><p><a href="../dev/#harder-way" data-document="../dev/" data-node="harder-way">Harder way</a></p><ul><li><p><a href="../dev/#database-setup" data-document="../dev/" data-node="database-setup">Database setup</a></p></li><li><p><a href="../dev/#building-and-running-lisp-components" data-document="../dev/" data-node="building-and-running-lisp-components">Building and running lisp components</a></p></li><li><p><a href="../dev/#connecting-worker-to-the-main-application" data-document="../dev/" data-node="connecting-worker-to-the-main-application">Connecting worker to the main application</a></p></li><li><p><a href="../dev/#checking-if-everything-works" data-document="../dev/" data-node="checking-if-everything-works">Checking if everything works</a></p></li><li><p><a href="../dev/#building-the-search-index" data-document="../dev/" data-node="building-the-search-index">Building the search index</a></p></li></ul></li></ul></li><li><p><a href="../self-hosting/#x-28ULTRALISP-DOCS-2FSELF-HOSTING-3A-3A-40SELF-HOSTING-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29" data-document="../self-hosting/" data-node="x-28ULTRALISP-DOCS-2FSELF-HOSTING-3A-3A-40SELF-HOSTING-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29">How to host Ultralisp on my own server</a></p><ul><li><p><a href="../self-hosting/#easy-way" data-document="../self-hosting/" data-node="easy-way">Easy way</a></p></li><li><p><a href="../self-hosting/#harder-way" data-document="../self-hosting/" data-node="harder-way">Harder way</a></p></li><li><p><a href="../self-hosting/#uploading-distribution-to-s3" data-document="../self-hosting/" data-node="uploading-distribution-to-s3">Uploading distribution to S3</a></p><ul><li><p><a href="../self-hosting/#how-to-create-a-bucket" data-document="../self-hosting/" data-node="how-to-create-a-bucket">How to create a bucket</a></p></li><li><p><a href="../self-hosting/#setup-a-proxy-server" data-document="../self-hosting/" data-node="setup-a-proxy-server">Setup a proxy server</a></p></li></ul></li></ul></li><li><p><a href="../hacking/#x-28ULTRALISP-DOCS-2FHACKING-3A-3A-40HACKING-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29" data-document="../hacking/" data-node="x-28ULTRALISP-DOCS-2FHACKING-3A-3A-40HACKING-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29">Hacking around</a></p><ul><li><p><a href="../hacking/#running-and-creating-database-migrations" data-document="../hacking/" data-node="running-and-creating-database-migrations">Running and creating database migrations</a></p></li><li><p><a href="../hacking/#running-tests" data-document="../hacking/" data-node="running-tests">Running tests</a></p></li><li><p><a href="../hacking/#interesting-environment-variables" data-document="../hacking/" data-node="interesting-environment-variables">Interesting environment variables</a></p></li></ul></li><li><p><a href="../releases/#x-28ULTRALISP-DOCS-2FRELEASES-3A-3A-40RELEASES-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29" data-document="../releases/" data-node="x-28ULTRALISP-DOCS-2FRELEASES-3A-3A-40RELEASES-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29">How to release new Ultralisp version</a></p><ul><li><p><a href="../releases/#making-a-new-release" data-document="../releases/" data-node="making-a-new-release">Making a new release</a></p></li></ul></li></ul>
     </div>
    </div><div class=footer>
     <a href="https://40ants.com/doc">[generated by 40ANTS-DOC]</a>
    </div>
   </div><div class=content role=main><h1>Architecture<a class=header-link
     href=#x-28ULTRALISP-DOCS-2FARCHITECTURE-3A-3A-40ARCHITECTURE-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29
     title="Permalink to this headline"
     id=x-28ULTRALISP-DOCS-2FARCHITECTURE-3A-3A-40ARCHITECTURE-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29></a></h1><h2 id="components-of-the-system">Components of the system</h2><p>Ultralisp consists of many moving parts:</p><p><img src="../docs/images/architecture.png"></p><p>All components running in the Digital Ocean are running as Docker containers.</p><h3 id="main-app">MainApp</h3><p>MainApp implements most logic:</p><ul><li><p>It returns web pages of Ultralisp.org (the Reblocks framework is used).</p></li><li><p>It runs a cron-like process for such regular tasks as:</p></li><li><p>Checking of new code for all registered projects.</p></li><li><p>Building new versions of the distribution.</p></li><li><p>Updating a search index in ElasticSearch.</p></li></ul><p>New code checks requires to load asd files and to check if each asd system is loadable. To make this process
more secure, MainApp sends request for a check to the Gearman server and Worker receives this request, then
performs a check and returns result back to the MainApp. During the check Worker has only a read-only access to the database.
After the each check, container with Worker dies to start the next check from a scratch.</p><p>Periods between project checks by cron are calculated with respect to the distance between recent commits in the project's repository.
Also a project owner may setup a web hook and the project will be updated as soon as possible after the restart.</p><h3 id="worker">Worker</h3><p>Worker app just listens to the Gearman server and waits for a command to check the project. In production this container dies after the each check. For convenience of development it is possible to make many checks in the same process.</p><p>For each project's source Ultralisp remebers the git commit used to build the most recent release. Worker fetches new commits and see if the last one is different from the commit hash stored in the database. If it is differ, then Worker searches for all asd files, loads them and returns to the MainApp a new commit hash and a list of <code>ASDF</code> systems.</p><p>After the successful check, MainApp creates a new revision of the project's check and a binds it to a new version of the distribution. Then MainApp builds a new distrubution by downloading a new source of the project, archiving it and uploading to the Amazon <code>S3</code> (for development a local storage is used instead).</p><h3 id="gearman">Gearman</h3><p>This component is an opensource <code>RPC</code> server, it works like a proxy between MainApp and Worker. This way we can scale worker and run a multiple instances to speed up the checking some day.</p><p>To run Gearman we are using <a href="https://github.com/artefactual-labs/docker-gearmand">this</a> docker image from Artefactual Labs.</p><h3 id="file-storage">FileStorage</h3><p>Amazon <code>S3</code> is used as a storage for all project releases and dist metadata. CloudFlare proxies all requests to the https://dist.ultralisp.org/ into the Amazon <code>S3</code> bucket.</p><p>During development all releases and metadata are saved into the local filesystem and can MainApp can serve them as static files.</p>
   </div>
  </div>
 </body>
</html>