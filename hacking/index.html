<html lang=en>
 <head>
  <meta charset=UTF-8><meta name=viewport
      content="width=device-width, initial-scale=1">
  <title>Hacking around</title>
  <link rel=alternate
        href="https://ultralisp.github.io/ultralisp/changelog.xml"
        type="application/rss+xml">
  <link rel=stylesheet type="text/css"
        href="../theme.css">
  <script type="text/javascript" src="../jquery.js"></script>
  <script type="text/javascript" src="../toc.js"></script>
  <script type="text/javascript">$(document).ready(function() {$('a:has(img)').css('border-bottom', 'none')})</script>
  <link rel=stylesheet type="text/css"
      href="../highlight.min.css">
  <script type="text/javascript"
          src="../highlight.min.js"></script>
  <script type="text/javascript">hljs.highlightAll();</script>
 </head>
 <body>
  <div class=page><div class=sidebar><div class=header><form class=search method=GET
      action="../search/">
      <input type=text name=q>
      <input type=submit value=Search><span id=search-progress></span>
     </form>
    </div><div class=content><div class=page-toc><ul><li><p><a href="../#x-28ULTRALISP-DOCS-2FINDEX-3A-40INDEX-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29" data-document="../" data-node="x-28ULTRALISP-DOCS-2FINDEX-3A-40INDEX-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29">Introduction</a></p><ul><li><p><a href="../#what-is-this" data-document="../" data-node="what-is-this">What is this?</a></p></li><li><p><a href="../#how-to-use-it" data-document="../" data-node="how-to-use-it">How to use it?</a></p></li></ul></li><li><p><a href="../architecture/#x-28ULTRALISP-DOCS-2FARCHITECTURE-3A-3A-40ARCHITECTURE-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29" data-document="../architecture/" data-node="x-28ULTRALISP-DOCS-2FARCHITECTURE-3A-3A-40ARCHITECTURE-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29">Architecture</a></p><ul><li><p><a href="../architecture/#components-of-the-system" data-document="../architecture/" data-node="components-of-the-system">Components of the system</a></p><ul><li><p><a href="../architecture/#main-app" data-document="../architecture/" data-node="main-app">MainApp</a></p></li><li><p><a href="../architecture/#worker" data-document="../architecture/" data-node="worker">Worker</a></p></li><li><p><a href="../architecture/#gearman" data-document="../architecture/" data-node="gearman">Gearman</a></p></li><li><p><a href="../architecture/#file-storage" data-document="../architecture/" data-node="file-storage">FileStorage</a></p></li></ul></li></ul></li><li><p><a href="../dev/#x-28ULTRALISP-DOCS-2FDEV-3A-3A-40DEV-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29" data-document="../dev/" data-node="x-28ULTRALISP-DOCS-2FDEV-3A-3A-40DEV-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29">Development</a></p><ul><li><p><a href="../dev/#running-in-dev" data-document="../dev/" data-node="running-in-dev">Running in dev</a></p><ul><li><p><a href="../dev/#easy-way" data-document="../dev/" data-node="easy-way">Easy way</a></p></li></ul></li><li><p><a href="../dev/#harder-way" data-document="../dev/" data-node="harder-way">Harder way</a></p><ul><li><p><a href="../dev/#database-setup" data-document="../dev/" data-node="database-setup">Database setup</a></p></li><li><p><a href="../dev/#building-and-running-lisp-components" data-document="../dev/" data-node="building-and-running-lisp-components">Building and running lisp components</a></p></li><li><p><a href="../dev/#connecting-worker-to-the-main-application" data-document="../dev/" data-node="connecting-worker-to-the-main-application">Connecting worker to the main application</a></p></li><li><p><a href="../dev/#checking-if-everything-works" data-document="../dev/" data-node="checking-if-everything-works">Checking if everything works</a></p></li><li><p><a href="../dev/#building-the-search-index" data-document="../dev/" data-node="building-the-search-index">Building the search index</a></p></li></ul></li></ul></li><li><p><a href="../self-hosting/#x-28ULTRALISP-DOCS-2FSELF-HOSTING-3A-3A-40SELF-HOSTING-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29" data-document="../self-hosting/" data-node="x-28ULTRALISP-DOCS-2FSELF-HOSTING-3A-3A-40SELF-HOSTING-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29">How to host Ultralisp on my own server</a></p><ul><li><p><a href="../self-hosting/#easy-way" data-document="../self-hosting/" data-node="easy-way">Easy way</a></p></li><li><p><a href="../self-hosting/#harder-way" data-document="../self-hosting/" data-node="harder-way">Harder way</a></p></li><li><p><a href="../self-hosting/#uploading-distribution-to-s3" data-document="../self-hosting/" data-node="uploading-distribution-to-s3">Uploading distribution to S3</a></p><ul><li><p><a href="../self-hosting/#how-to-create-a-bucket" data-document="../self-hosting/" data-node="how-to-create-a-bucket">How to create a bucket</a></p></li><li><p><a href="../self-hosting/#setup-a-proxy-server" data-document="../self-hosting/" data-node="setup-a-proxy-server">Setup a proxy server</a></p></li></ul></li></ul></li><li><p><a href="#x-28ULTRALISP-DOCS-2FHACKING-3A-3A-40HACKING-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29" data-document="" data-node="x-28ULTRALISP-DOCS-2FHACKING-3A-3A-40HACKING-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29">Hacking around</a></p><ul><li><p><a href="#running-and-creating-database-migrations" data-document="" data-node="running-and-creating-database-migrations">Running and creating database migrations</a></p></li><li><p><a href="#running-tests" data-document="" data-node="running-tests">Running tests</a></p></li><li><p><a href="#interesting-environment-variables" data-document="" data-node="interesting-environment-variables">Interesting environment variables</a></p></li></ul></li><li><p><a href="../releases/#x-28ULTRALISP-DOCS-2FRELEASES-3A-3A-40RELEASES-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29" data-document="../releases/" data-node="x-28ULTRALISP-DOCS-2FRELEASES-3A-3A-40RELEASES-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29">How to release new Ultralisp version</a></p><ul><li><p><a href="../releases/#making-a-new-release" data-document="../releases/" data-node="making-a-new-release">Making a new release</a></p></li></ul></li></ul>
     </div>
    </div><div class=footer>
     <a href="https://40ants.com/doc">[generated by 40ANTS-DOC]</a>
    </div>
   </div><div class=content role=main><h1>Hacking around<a class=header-link
     href=#x-28ULTRALISP-DOCS-2FHACKING-3A-3A-40HACKING-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29
     title="Permalink to this headline"
     id=x-28ULTRALISP-DOCS-2FHACKING-3A-3A-40HACKING-2040ANTS-DOC-2FLOCATIVES-3ASECTION-29></a></h1><p>During development, it is better to start docker compose with the following
arguments:</p><pre><code class="bash">docker-compose run --rm mito migrate
  
docker-compose up --build --abort-on-container-exit app</code></pre><p>Most such commands are defined in the <code>Lakefile</code>. Use <a href="https://github.com/takagi/lake">lake</a> to run
it like that:</p><pre><code class="bash">lake devserver</code></pre><p>Then you can connect to the web sever and worker using <code>SLY</code>. Just run in
the Emacs a command <code>sly-connect</code>, choose &quot;127.0.0.1&quot; as  a hostname
and <code>14005</code> as a port for webserver or <code>14006</code> as  a port to connect
to the worker.</p><p>To work in the <code>REPL</code>, you will need a connection to a database. Establish it
by running <code>(ultralisp/db:connect-toplevel)</code>.</p><h2 id="running-and-creating-database-migrations">Running and creating database migrations</h2><p>To generate a new database migration, run:</p><pre><code class="bash">docker-compose rm --stop --force empty-postgres
docker-compose run --rm mito generate-migration</code></pre><p>To rollup all migration to a dev database, run:</p><pre><code class="bash">docker-compose run --rm mito migrate</code></pre><p>If you want to experiment with database and then rollback the database's
state then create a dump with such command:</p><pre><code class="bash">docker-compose run --rm db-ops dump</code></pre><p>And when you want to restore the database's state, ensure that <code>app</code>
and <code>worker</code> containers are not running and run:</p><pre><code class="bash">docker stop ultralisp_app ultralisp_worker
docker-compose run --rm db-ops restore</code></pre><h2 id="running-tests">Running tests</h2><p>Install Postgres database, then create a test user and database:</p><pre><code class="bash">sudo -u postgres psql -c &quot;CREATE USER ultralisp_test WITH PASSWORD 'ultralisp_test'&quot;
sudo -u postgres psql -c &quot;CREATE DATABASE ultralisp_test OWNER = 'ultralisp_test'&quot;
sudo -u postgres createdb --owner ultralisp_test ultralisp_test</code></pre><p>Connect to the <code>REPL</code> and run:</p><pre><code class="lisp">(ql:quickload :ultralisp-test)
(setf (uiop:getenv &quot;POSTGRES_USER&quot;) &quot;ultralisp_test&quot;)
(setf (uiop:getenv &quot;POSTGRES_DBNAME&quot;) &quot;ultralisp_test&quot;)
(setf (uiop:getenv &quot;POSTGRES_PASS&quot;) &quot;ultralisp_test&quot;)
(setf (uiop:getenv &quot;POSTGRES_HOST&quot;) &quot;localhost&quot;)
   
(setf rove:*enable-colors* nil)
(setf rove:*debug-on-error* t)
(asdf:test-system :ultralisp-test)</code></pre><h2 id="interesting-environment-variables">Interesting environment variables</h2><ul><li><p><code>HIDE_SEARCH</code> - if you set it, then search bar will not render.
  But this does not disables projects indexing.</p></li><li><p><code>CRON_DISABLED</code> - turn off all cron jobs like project chechking,
  new version builds etc. Probably, we should create an admin page
  to perform these actions manually.</p></li></ul>
   </div>
  </div>
 </body>
</html>